<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prova Claude - Analisi Bilancio</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #e0f2fe 0%, #e8eaf6 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 20px; }
        .header h1 { color: #1e40af; font-size: 2.5rem; margin-bottom: 10px; }
        .header p { color: #6b7280; font-size: 1.1rem; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
        .tab { background: white; border: none; padding: 15px 25px; border-radius: 10px; cursor: pointer; font-weight: bold; color: #374151; transition: all 0.3s; }
        .tab:hover { background: #f3f4f6; }
        .tab.active { background: #2563eb; color: white; }
        .content { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 30px; min-height: 500px; }
        .year-filters { margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; }
        .year-filter { display: flex; align-items: center; gap: 5px; }
        .year-filter input { margin-right: 5px; }
        .tables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
        .table-container { background: #f9fafb; padding: 20px; border-radius: 8px; }
        .table-container h3 { color: #1e40af; margin-bottom: 15px; font-size: 1.2rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f3f4f6; font-weight: bold; }
        td.number { text-align: right; }
        .highlight-green { background: #dcfce7; font-weight: bold; }
        .highlight-blue { background: #dbeafe; font-weight: bold; }
        .indici-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .indice-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; background: white; }
        .indice-card h4 { color: #1e40af; margin-bottom: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .indice-values { display: grid; gap: 8px; }
        .indice-row { display: flex; justify-content: space-between; font-size: 0.9rem; }
        .explanation { background: #dbeafe; padding: 15px; border-radius: 6px; margin: 10px 0; font-size: 0.85rem; line-height: 1.4; display: none; }
        .explanation.show { display: block; }
        .export-btn { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .export-btn:hover { background: #1d4ed8; }
        
        /* Grafici CSS */
        .chart-container { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-container h3 { color: #1e40af; margin-bottom: 15px; }
        .line-chart { position: relative; height: 300px; padding: 20px; background: #f9fafb; border-radius: 8px; }
        .bar-chart { position: relative; height: 300px; padding: 20px; background: #f9fafb; border-radius: 8px; display: flex; align-items: end; gap: 10px; }
        .chart-legend { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .legend-color { width: 16px; height: 16px; border-radius: 2px; }
        .bar { display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 60px; }
        .bar-stack { width: 100%; display: flex; flex-direction: column-reverse; border-radius: 4px 4px 0 0; overflow: hidden; }
        .bar-segment { transition: all 0.3s ease; cursor: pointer; position: relative; }
        .bar-label { margin-top: 8px; font-size: 0.8rem; font-weight: bold; }
        .bar-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7rem; color: white; font-weight: bold; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); }
        .trend-line { position: relative; height: 250px; margin: 20px 0; }
        .trend-point { position: absolute; width: 8px; height: 8px; border-radius: 50%; border: 2px solid; transform: translate(-50%, -50%); cursor: pointer; }
        .trend-line-path { position: absolute; height: 2px; transform-origin: left center; }
        .trend-labels { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem; font-weight: bold; }
        .y-axis { position: absolute; left: 0; top: 0; height: 100%; display: flex; flex-direction: column; justify-content: space-between; font-size: 0.8rem; color: #6b7280; }
        .tooltip { position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 8px; border-radius: 4px; font-size: 0.8rem; pointer-events: none; z-index: 10; transform: translate(-50%, -100%); margin-top: -10px; }
        
        @media (max-width: 768px) { 
            .tables-grid { grid-template-columns: 1fr; } 
            .tabs { flex-direction: column; }
            .header h1 { font-size: 2rem; }
            .chart-legend { justify-content: center; }
            .bar { min-width: 40px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>Prova Claude</h1>
                    <p>Analisi di Bilancio e Merito Creditizio 2018-2022</p>
                </div>
                <button class="export-btn" onclick="window.print()">
                    ðŸ“„ Esporta PDF
                </button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('bilanci')">ðŸ“Š Bilanci</button>
            <button class="tab" onclick="showTab('grafici')">ðŸ“ˆ Grafici</button>
            <button class="tab" onclick="showTab('indici')">ðŸ§® Indici</button>
        </div>

        <!-- Content -->
        <div class="content">
            <div id="bilanci-content">
                <div class="year-filters">
                    <div class="year-filter">
                        <input type="checkbox" id="year2018" checked onchange="updateTables()">
                        <label for="year2018">2018</label>
                    </div>
                    <div class="year-filter">
                        <input type="checkbox" id="year2019" checked onchange="updateTables()">
                        <label for="year2019">2019</label>
                    </div>
                    <div class="year-filter">
                        <input type="checkbox" id="year2020" checked onchange="updateTables()">
                        <label for="year2020">2020</label>
                    </div>
                    <div class="year-filter">
                        <input type="checkbox" id="year2021" checked onchange="updateTables()">
                        <label for="year2021">2021</label>
                    </div>
                    <div class="year-filter">
                        <input type="checkbox" id="year2022" checked onchange="updateTables()">
                        <label for="year2022">2022</label>
                    </div>
                </div>

                <div class="tables-grid">
                    <div class="table-container">
                        <h3>Principali Voci Economiche</h3>
                        <div id="economic-table"></div>
                    </div>
                    <div class="table-container">
                        <h3>Principali Voci Patrimoniali</h3>
                        <div id="patrimonial-table"></div>
                    </div>
                </div>
            </div>

            <div id="grafici-content" style="display: none;">
                <h2 style="color: #1e40af; margin-bottom: 20px;">Grafici e Trend</h2>
                
                <div class="chart-container">
                    <h3>ðŸ“ˆ Trend Ricavi e MarginalitÃ </h3>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2563eb;"></div>
                            <span>Ricavi</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #059669;"></div>
                            <span>EBITDA</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc2626;"></div>
                            <span>Utile Netto</span>
                        </div>
                    </div>
                    <div id="revenue-chart" class="line-chart"></div>
                </div>

                <div class="chart-container">
                    <h3>ðŸ“Š Composizione Costi per Anno</h3>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ef4444;"></div>
                            <span>Costi Materie Prime</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f97316;"></div>
                            <span>Costi Servizi</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #eab308;"></div>
                            <span>Costi Personale</span>
                        </div>
                    </div>
                    <div id="costs-chart" class="bar-chart"></div>
                </div>

                <div class="chart-container">
                    <h3>ðŸ’° Struttura Patrimoniale</h3>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2563eb;"></div>
                            <span>Totale Attivo</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc2626;"></div>
                            <span>Debiti Totali</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #059669;"></div>
                            <span>DisponibilitÃ  Liquide</span>
                        </div>
                    </div>
                    <div id="patrimonial-chart" class="line-chart"></div>
                </div>
            </div>

            <div id="indici-content" style="display: none;">
                <h2 style="color: #1e40af; margin-bottom: 20px;">Indici di Bilancio</h2>
                
                <h3 style="color: #1e40af; margin: 30px 0 15px 0;">Indici di RedditivitÃ </h3>
                <div class="indici-grid" id="indici-redditivita"></div>

                <div class="chart-container">
                    <h3>ðŸ“ˆ Trend Indici di RedditivitÃ </h3>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #059669;"></div>
                            <span>EBITDA Margin (%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2563eb;"></div>
                            <span>ROI (%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>ROA (%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc2626;"></div>
                            <span>ROS (%)</span>
                        </div>
                    </div>
                    <div id="profitability-chart" class="line-chart"></div>
                </div>

                <h3 style="color: #1e40af; margin: 30px 0 15px 0;">Indici Finanziari</h3>
                <div class="indici-grid" id="indici-finanziari"></div>

                <div class="chart-container">
                    <h3>ðŸ“ˆ Trend Indici Finanziari</h3>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>Current Ratio</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <span>Quick Ratio</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ef4444;"></div>
                            <span>Debt/Equity</span>
                        </div>
                    </div>
                    <div id="financial-chart" class="line-chart"></div>
                </div>

                <h3 style="color: #1e40af; margin: 30px 0 15px 0;">Indici Patrimoniali</h3>
                <div class="indici-grid" id="indici-patrimoniali"></div>

                <div class="chart-container">
                    <h3>ðŸ“ˆ Trend Indici Patrimoniali</h3>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #8b5cf6;"></div>
                            <span>Autonomia Finanziaria (%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f97316;"></div>
                            <span>Copertura Immobilizzazioni (%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #06b6d4;"></div>
                            <span>Composizione Attivo (%)</span>
                        </div>
                    </div>
                    <div id="patrimonial-indicators-chart" class="line-chart"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dati bilancio
        const bilanciData = {
            2018: { ricavi: 3309088.36, costiMateriePrime: 2470143.95, costiServizi: 147601.19, costiPersonale: 364594.50, ebitda: 349752.84, ebit: 236283.96, utileNetto: 196830.74, totaleAttivo: 1485573.82, patrimonioNetto: -245380.66, debiti: 1627605.40, disponibilitaLiquide: 34441.01, creditiBreveTermine: 338604.22, debitiBreveTermine: 1028265.04, immobilizzazioni: 446653.51 },
            2019: { ricavi: 3366178.45, costiMateriePrime: 2445141.12, costiServizi: 140795.63, costiPersonale: 412476.08, ebitda: 304494.49, ebit: 179494.28, utileNetto: 108728.00, totaleAttivo: 1775803.14, patrimonioNetto: -39874.67, debiti: 1718380.97, disponibilitaLiquide: 43763.96, creditiBreveTermine: 377666.17, debitiBreveTermine: 978439.25, immobilizzazioni: 662935.12 },
            2020: { ricavi: 2990942.51, costiMateriePrime: 2163702.64, costiServizi: 108049.90, costiPersonale: 311994.55, ebitda: 331901.82, ebit: 331901.82, utileNetto: 265749.73, totaleAttivo: 1822729.95, patrimonioNetto: 66495.06, debiti: 1639353.32, disponibilitaLiquide: 30375.06, creditiBreveTermine: 425190.50, debitiBreveTermine: 988019.58, immobilizzazioni: 689042.80 },
            2021: { ricavi: 3417154.76, costiMateriePrime: 2429442.44, costiServizi: 129159.43, costiPersonale: 316873.39, ebitda: 331034.54, ebit: 201342.87, utileNetto: 142289.65, totaleAttivo: 1681933.20, patrimonioNetto: -8553.15, debiti: 1566440.57, disponibilitaLiquide: 140490.33, creditiBreveTermine: 427639.16, debitiBreveTermine: 698948.32, immobilizzazioni: 584204.65 },
            2022: { ricavi: 3705919.37, costiMateriePrime: 2389835.66, costiServizi: 156181.88, costiPersonale: 398371.74, ebitda: 507768.65, ebit: 408309.91, utileNetto: 355752.72, totaleAttivo: 1625391.93, patrimonioNetto: -4536.18, debiti: 1556542.10, disponibilitaLiquide: 207194.23, creditiBreveTermine: 506680.43, debitiBreveTermine: 769551.41, immobilizzazioni: 533920.64 }
        };

        const explanations = {
            ebitdaMargin: "EBITDA rappresenta il margine operativo lordo, la capacitÃ  dell'azienda di generare ricchezza dalla sua attivitÃ  operativa.",
            roi: "ROI misura la redditivitÃ  del capitale investito. Indica quanto rende ogni euro investito nell'azienda.",
            roa: "ROA misura la redditivitÃ  del totale attivo. Indica quanto utile genera ogni euro di attivitÃ  investita.",
            ros: "ROS misura la redditivitÃ  delle vendite. Indica quanto utile genera ogni euro di fatturato.",
            currentRatio: "Current Ratio misura la liquiditÃ  corrente. CapacitÃ  di far fronte ai debiti a breve termine.",
            quickRatio: "Quick Ratio misura la liquiditÃ  immediata usando solo le disponibilitÃ  liquide.",
            debtToEquity: "Debt to Equity misura il rapporto tra debiti e patrimonio netto.",
            autonomiaFinanziaria: "Autonomia Finanziaria indica la percentuale di attivitÃ  finanziate con mezzi propri.",
            coperturaImmobilizzazioni: "Copertura Immobilizzazioni indica se le immobilizzazioni sono finanziate con capitale proprio.",
            composizioneAttivo: "Composizione Attivo indica la percentuale di immobilizzazioni sul totale attivo."
        };

        function formatCurrency(value) {
            return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        }

        function formatPercentage(value) {
            return `${value.toFixed(2)}%`;
        }

        function formatNumber(value) {
            if (value >= 1000000) {
                return (value / 1000000).toFixed(2) + 'M';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(2) + 'K';
            } else if (value >= 1) {
                return value.toFixed(2);
            } else {
                return value.toFixed(2);
            }
        }

        function getSelectedYears() {
            const years = [];
            for (let year = 2018; year <= 2022; year++) {
                if (document.getElementById(`year${year}`).checked) {
                    years.push(year.toString());
                }
            }
            return years;
        }

        function calcolaIndici() {
            const indici = {};
            Object.keys(bilanciData).forEach(anno => {
                const data = bilanciData[anno];
                const roi = (data.ebit / data.totaleAttivo) * 100;
                const roa = (data.utileNetto / data.totaleAttivo) * 100;
                const ros = (data.utileNetto / data.ricavi) * 100;
                const ebitdaMargin = (data.ebitda / data.ricavi) * 100;
                const currentRatio = data.debitiBreveTermine > 0 ? (data.creditiBreveTermine + data.disponibilitaLiquide) / data.debitiBreveTermine : 0;
                const quickRatio = data.debitiBreveTermine > 0 ? data.disponibilitaLiquide / data.debitiBreveTermine : 0;
                const debtToEquity = data.patrimonioNetto > 0 ? data.debiti / data.patrimonioNetto : 0;
                const autonomiaFinanziaria = data.patrimonioNetto > 0 ? (data.patrimonioNetto / data.totaleAttivo) * 100 : 0;
                const coperturaImmobilizzazioni = data.immobilizzazioni > 0 ? (data.patrimonioNetto / data.immobilizzazioni) * 100 : 0;
                const composizioneAttivo = (data.immobilizzazioni / data.totaleAttivo) * 100;
                indici[anno] = { roi, roa, ros, ebitdaMargin, currentRatio, quickRatio, debtToEquity, autonomiaFinanziaria, coperturaImmobilizzazioni, composizioneAttivo };
            });
            return indici;
        }

        function createLineChart(containerId, datasets) {
            const container = document.getElementById(containerId);
            const years = Object.keys(bilanciData);
            
            container.innerHTML = '';
            container.style.position = 'relative';
            container.style.height = '400px';
            container.style.padding = '40px 20px 60px 80px';
            container.style.background = '#ffffff';
            container.style.border = '1px solid #e5e7eb';
            container.style.borderRadius = '8px';
            
            // Canvas per il grafico
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 300;
            canvas.style.width = '100%';
            canvas.style.height = '300px';
            
            const ctx = canvas.getContext('2d');
            
            // Trova min e max per scaling
            let maxVal = Math.max(...datasets.flatMap(d => d.data));
            let minVal = Math.min(...datasets.flatMap(d => d.data));
            if (minVal > 0) minVal = 0;
            
            const padding = 40;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            
            // Funzione per convertire coordinate
            function getX(index) {
                return padding + (index / (years.length - 1)) * chartWidth;
            }
            
            function getY(value) {
                return padding + (1 - (value - minVal) / (maxVal - minVal)) * chartHeight;
            }
            
            // Disegna griglia
            ctx.strokeStyle = '#f3f4f6';
            ctx.lineWidth = 1;
            
            // Linee orizzontali
            for (let i = 0; i <= 5; i++) {
                const y = padding + (i / 5) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
            }
            
            // Linee verticali
            for (let i = 0; i < years.length; i++) {
                const x = getX(i);
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, padding + chartHeight);
                ctx.stroke();
            }
            
            // Disegna le linee dei dataset
            datasets.forEach((dataset, datasetIndex) => {
                ctx.strokeStyle = dataset.color;
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // Disegna la linea
                ctx.beginPath();
                dataset.data.forEach((value, index) => {
                    const x = getX(index);
                    const y = getY(value);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Disegna i punti
                ctx.fillStyle = dataset.color;
                dataset.data.forEach((value, index) => {
                    const x = getX(index);
                    const y = getY(value);
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 6, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Bordo bianco per i punti
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.strokeStyle = dataset.color;
                    ctx.lineWidth = 3;
                });
            });
            
            // Aggiungi etichette asse Y
            const yLabelsDiv = document.createElement('div');
            yLabelsDiv.style.position = 'absolute';
            yLabelsDiv.style.left = '0';
            yLabelsDiv.style.top = '40px';
            yLabelsDiv.style.height = '300px';
            yLabelsDiv.style.width = '70px';
            yLabelsDiv.style.display = 'flex';
            yLabelsDiv.style.flexDirection = 'column';
            yLabelsDiv.style.justifyContent = 'space-between';
            yLabelsDiv.style.fontSize = '12px';
            yLabelsDiv.style.color = '#6b7280';
            yLabelsDiv.style.textAlign = 'right';
            yLabelsDiv.style.paddingRight = '10px';
            
            for (let i = 0; i <= 5; i++) {
                const value = maxVal - (maxVal - minVal) * (i / 5);
                const label = document.createElement('div');
                label.textContent = formatNumber(value);
                yLabelsDiv.appendChild(label);
            }
            
            // Aggiungi etichette asse X
            const xLabelsDiv = document.createElement('div');
            xLabelsDiv.style.position = 'absolute';
            xLabelsDiv.style.bottom = '20px';
            xLabelsDiv.style.left = '80px';
            xLabelsDiv.style.right = '20px';
            xLabelsDiv.style.display = 'flex';
            xLabelsDiv.style.justifyContent = 'space-between';
            xLabelsDiv.style.fontSize = '12px';
            xLabelsDiv.style.color = '#6b7280';
            xLabelsDiv.style.fontWeight = 'bold';
            
            years.forEach(year => {
                const label = document.createElement('div');
                label.textContent = year;
                xLabelsDiv.appendChild(label);
            });
            
            container.appendChild(yLabelsDiv);
            container.appendChild(canvas);
            container.appendChild(xLabelsDiv);
            
            // Aggiungi interattivitÃ 
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const mouseX = (e.clientX - rect.left) * scaleX;
                const mouseY = (e.clientY - rect.top) * scaleY;
                
                // Trova il punto piÃ¹ vicino
                let closestPoint = null;
                let minDistance = Infinity;
                
                datasets.forEach((dataset, datasetIndex) => {
                    dataset.data.forEach((value, index) => {
                        const x = getX(index);
                        const y = getY(value);
                        const distance = Math.sqrt(Math.pow(mouseX - x, 2) + Math.pow(mouseY - y, 2));
                        
                        if (distance < 15 && distance < minDistance) {
                            minDistance = distance;
                            closestPoint = {
                                dataset: dataset,
                                value: value,
                                year: years[index],
                                x: x,
                                y: y
                            };
                        }
                    });
                });
                
                // Mostra tooltip
                const existingTooltip = container.querySelector('.chart-tooltip');
                if (existingTooltip) existingTooltip.remove();
                
                if (closestPoint) {
                    canvas.style.cursor = 'pointer';
                    const tooltip = document.createElement('div');
                    tooltip.className = 'chart-tooltip';
                    tooltip.style.position = 'absolute';
                    tooltip.style.background = 'rgba(0,0,0,0.8)';
                    tooltip.style.color = 'white';
                    tooltip.style.padding = '8px 12px';
                    tooltip.style.borderRadius = '4px';
                    tooltip.style.fontSize = '12px';
                    tooltip.style.pointerEvents = 'none';
                    tooltip.style.zIndex = '1000';
                    tooltip.textContent = `${closestPoint.dataset.label} (${closestPoint.year}): ${closestPoint.dataset.format ? closestPoint.dataset.format(closestPoint.value) : formatNumber(closestPoint.value)}`;
                    
                    const tooltipX = (closestPoint.x / scaleX) - 50;
                    const tooltipY = (closestPoint.y / scaleY) - 40;
                    
                    tooltip.style.left = tooltipX + 'px';
                    tooltip.style.top = tooltipY + 'px';
                    
                    container.appendChild(tooltip);
                } else {
                    canvas.style.cursor = 'default';
                }
            });
            
            canvas.addEventListener('mouseleave', () => {
                const tooltip = container.querySelector('.chart-tooltip');
                if (tooltip) tooltip.remove();
                canvas.style.cursor = 'default';
            });
        }

        function createBarChart(containerId, datasets) {
            const container = document.getElementById(containerId);
            const years = Object.keys(bilanciData);
            
            container.innerHTML = '';
            container.style.position = 'relative';
            container.style.height = '400px';
            container.style.padding = '40px 20px 60px 80px';
            container.style.background = '#ffffff';
            container.style.border = '1px solid #e5e7eb';
            container.style.borderRadius = '8px';
            
            // Canvas per il grafico
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 300;
            canvas.style.width = '100%';
            canvas.style.height = '300px';
            
            const ctx = canvas.getContext('2d');
            
            // Calcola totali per ogni anno
            const yearTotals = years.map(year => 
                datasets.reduce((sum, dataset, index) => sum + dataset.data[years.indexOf(year)], 0)
            );
            const maxTotal = Math.max(...yearTotals);
            
            const padding = 40;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const barWidth = chartWidth / years.length * 0.6;
            const barSpacing = chartWidth / years.length;
            
            // Disegna griglia orizzontale
            ctx.strokeStyle = '#f3f4f6';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 5; i++) {
                const y = padding + (i / 5) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
            }
            
            // Disegna le barre per ogni anno
            years.forEach((year, yearIndex) => {
                const x = padding + yearIndex * barSpacing + (barSpacing - barWidth) / 2;
                let stackedHeight = 0;
                
                datasets.forEach((dataset, datasetIndex) => {
                    const value = dataset.data[yearIndex];
                    const barHeight = (value / maxTotal) * chartHeight;
                    const y = padding + chartHeight - stackedHeight - barHeight;
                    
                    // Disegna segmento barra
                    ctx.fillStyle = dataset.color;
                    ctx.fillRect(x, y, barWidth, barHeight);
                    
                    // Bordo per separare i segmenti
                    if (datasetIndex > 0) {
                        ctx.strokeStyle = '#ffffff';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(x + barWidth, y);
                        ctx.stroke();
                    }
                    
                    // Etichetta valore se abbastanza grande
                    if (barHeight > 20) {
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 11px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(formatNumber(value), x + barWidth/2, y + barHeight/2);
                    }
                    
                    stackedHeight += barHeight;
                });
            });
            
            // Aggiungi etichette asse Y
            const yLabelsDiv = document.createElement('div');
            yLabelsDiv.style.position = 'absolute';
            yLabelsDiv.style.left = '0';
            yLabelsDiv.style.top = '40px';
            yLabelsDiv.style.height = '300px';
            yLabelsDiv.style.width = '70px';
            yLabelsDiv.style.display = 'flex';
            yLabelsDiv.style.flexDirection = 'column';
            yLabelsDiv.style.justifyContent = 'space-between';
            yLabelsDiv.style.fontSize = '12px';
            yLabelsDiv.style.color = '#6b7280';
            yLabelsDiv.style.textAlign = 'right';
            yLabelsDiv.style.paddingRight = '10px';
            
            for (let i = 0; i <= 5; i++) {
                const value = maxTotal * (1 - i / 5);
                const label = document.createElement('div');
                label.textContent = formatNumber(value);
                yLabelsDiv.appendChild(label);
            }
            
            // Aggiungi etichette asse X
            const xLabelsDiv = document.createElement('div');
            xLabelsDiv.style.position = 'absolute';
            xLabelsDiv.style.bottom = '20px';
            xLabelsDiv.style.left = '80px';
            xLabelsDiv.style.right = '20px';
            xLabelsDiv.style.display = 'flex';
            xLabelsDiv.style.justifyContent = 'space-between';
            xLabelsDiv.style.fontSize = '12px';
            xLabelsDiv.style.color = '#6b7280';
            xLabelsDiv.style.fontWeight = 'bold';
            
            years.forEach(year => {
                const label = document.createElement('div');
                label.textContent = year;
                xLabelsDiv.appendChild(label);
            });
            
            container.appendChild(yLabelsDiv);
            container.appendChild(canvas);
            container.appendChild(xLabelsDiv);
            
            // InterattivitÃ 
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const mouseX = (e.clientX - rect.left) * scaleX;
                const mouseY = (e.clientY - rect.top) * scaleY;
                
                // Trova quale barra
                const yearIndex = Math.floor((mouseX - padding) / barSpacing);
                if (yearIndex >= 0 && yearIndex < years.length) {
                    const x = padding + yearIndex * barSpacing + (barSpacing - barWidth) / 2;
                    
                    if (mouseX >= x && mouseX <= x + barWidth) {
                        // Trova quale segmento
                        let stackedHeight = 0;
                        for (let i = 0; i < datasets.length; i++) {
                            const value = datasets[i].data[yearIndex];
                            const barHeight = (value / maxTotal) * chartHeight;
                            const segmentTop = padding + chartHeight - stackedHeight - barHeight;
                            const segmentBottom = segmentTop + barHeight;
                            
                            if (mouseY >= segmentTop && mouseY <= segmentBottom) {
                                canvas.style.cursor = 'pointer';
                                
                                // Mostra tooltip
                                const existingTooltip = container.querySelector('.chart-tooltip');
                                if (existingTooltip) existingTooltip.remove();
                                
                                const tooltip = document.createElement('div');
                                tooltip.className = 'chart-tooltip';
                                tooltip.style.position = 'absolute';
                                tooltip.style.background = 'rgba(0,0,0,0.8)';
                                tooltip.style.color = 'white';
                                tooltip.style.padding = '8px 12px';
                                tooltip.style.borderRadius = '4px';
                                tooltip.style.fontSize = '12px';
                                tooltip.style.pointerEvents = 'none';
                                tooltip.style.zIndex = '1000';
                                tooltip.textContent = `${datasets[i].label} (${years[yearIndex]}): ${formatCurrency(value)}`;
                                
                                tooltip.style.left = (e.clientX - rect.left - 60) + 'px';
                                tooltip.style.top = (e.clientY - rect.top - 40) + 'px';
                                
                                container.appendChild(tooltip);
                                return;
                            }
                            stackedHeight += barHeight;
                        }
                    }
                }
                
                canvas.style.cursor = 'default';
                const tooltip = container.querySelector('.chart-tooltip');
                if (tooltip) tooltip.remove();
            });
            
            canvas.addEventListener('mouseleave', () => {
                const tooltip = container.querySelector('.chart-tooltip');
                if (tooltip) tooltip.remove();
                canvas.style.cursor = 'default';
            });
        }

        function createCharts() {
            const years = Object.keys(bilanciData);
            
            // Revenue Chart
            createLineChart('revenue-chart', [
                {
                    label: 'Ricavi',
                    data: years.map(year => bilanciData[year].ricavi),
                    color: '#2563eb',
                    format: formatCurrency
                },
                {
                    label: 'EBITDA',
                    data: years.map(year => bilanciData[year].ebitda),
                    color: '#059669',
                    format: formatCurrency
                },
                {
                    label: 'Utile Netto',
                    data: years.map(year => bilanciData[year].utileNetto),
                    color: '#dc2626',
                    format: formatCurrency
                }
            ]);
            
            // Costs Chart
            createBarChart('costs-chart', [
                {
                    label: 'Costi Materie Prime',
                    data: years.map(year => bilanciData[year].costiMateriePrime),
                    color: '#ef4444'
                },
                {
                    label: 'Costi Servizi',
                    data: years.map(year => bilanciData[year].costiServizi),
                    color: '#f97316'
                },
                {
                    label: 'Costi Personale',
                    data: years.map(year => bilanciData[year].costiPersonale),
                    color: '#eab308'
                }
            ]);
            
            // Patrimonial Chart
            createLineChart('patrimonial-chart', [
                {
                    label: 'Totale Attivo',
                    data: years.map(year => bilanciData[year].totaleAttivo),
                    color: '#2563eb',
                    format: formatCurrency
                },
                {
                    label: 'Debiti Totali',
                    data: years.map(year => bilanciData[year].debiti),
                    color: '#dc2626',
                    format: formatCurrency
                },
                {
                    label: 'DisponibilitÃ  Liquide',
                    data: years.map(year => bilanciData[year].disponibilitaLiquide),
                    color: '#059669',
                    format: formatCurrency
                }
            ]);
        }

        function createIndicatorCharts() {
            const years = Object.keys(bilanciData);
            const indici = calcolaIndici();
            
            // Profitability Chart
            createLineChart('profitability-chart', [
                {
                    label: 'EBITDA Margin',
                    data: years.map(year => indici[year].ebitdaMargin),
                    color: '#059669',
                    format: (val) => val.toFixed(1) + '%'
                },
                {
                    label: 'ROI',
                    data: years.map(year => indici[year].roi),
                    color: '#2563eb',
                    format: (val) => val.toFixed(1) + '%'
                },
                {
                    label: 'ROA',
                    data: years.map(year => indici[year].roa),
                    color: '#f59e0b',
                    format: (val) => val.toFixed(1) + '%'
                },
                {
                    label: 'ROS',
                    data: years.map(year => indici[year].ros),
                    color: '#dc2626',
                    format: (val) => val.toFixed(1) + '%'
                }
            ]);
            
            // Financial Chart
            createLineChart('financial-chart', [
                {
                    label: 'Current Ratio',
                    data: years.map(year => indici[year].currentRatio),
                    color: '#10b981',
                    format: (val) => val.toFixed(2)
                },
                {
                    label: 'Quick Ratio',
                    data: years.map(year => indici[year].quickRatio),
                    color: '#3b82f6',
                    format: (val) => val.toFixed(2)
                },
                {
                    label: 'Debt/Equity',
                    data: years.map(year => indici[year].debtToEquity),
                    color: '#ef4444',
                    format: (val) => val.toFixed(2)
                }
            ]);
            
            // Patrimonial Indicators Chart
            createLineChart('patrimonial-indicators-chart', [
                {
                    label: 'Autonomia Finanziaria',
                    data: years.map(year => indici[year].autonomiaFinanziaria),
                    color: '#8b5cf6',
                    format: (val) => val.toFixed(1) + '%'
                },
                {
                    label: 'Copertura Immobilizzazioni',
                    data: years.map(year => indici[year].coperturaImmobilizzazioni),
                    color: '#f97316',
                    format: (val) => val.toFixed(1) + '%'
                },
                {
                    label: 'Composizione Attivo',
                    data: years.map(year => indici[year].composizioneAttivo),
                    color: '#06b6d4',
                    format: (val) => val.toFixed(1) + '%'
                }
            ]);
        }

        function updateTables() {
            const selectedYears = getSelectedYears();
            
            // Tabella economica
            let economicHTML = '<table><thead><tr><th>Voce</th>';
            selectedYears.forEach(year => {
                economicHTML += `<th>${year}</th>`;
            });
            economicHTML += '</tr></thead><tbody>';

            const economicRows = [
                { label: 'Ricavi', key: 'ricavi', class: '' },
                { label: 'Costi Materie Prime', key: 'costiMateriePrime', class: '' },
                { label: 'Costi Servizi', key: 'costiServizi', class: '' },
                { label: 'Costi Personale', key: 'costiPersonale', class: '' },
                { label: 'EBITDA', key: 'ebitda', class: 'highlight-green' },
                { label: 'Utile Netto', key: 'utileNetto', class: 'highlight-blue' }
            ];

            economicRows.forEach(row => {
                economicHTML += `<tr class="${row.class}"><td>${row.label}</td>`;
                selectedYears.forEach(year => {
                    economicHTML += `<td class="number">${formatCurrency(bilanciData[year][row.key])}</td>`;
                });
                economicHTML += '</tr>';
            });
            economicHTML += '</tbody></table>';
            document.getElementById('economic-table').innerHTML = economicHTML;

            // Tabella patrimoniale
            let patrimonialHTML = '<table><thead><tr><th>Voce</th>';
            selectedYears.forEach(year => {
                patrimonialHTML += `<th>${year}</th>`;
            });
            patrimonialHTML += '</tr></thead><tbody>';

            const patrimonialRows = [
                { label: 'Totale Attivo', key: 'totaleAttivo' },
                { label: 'Patrimonio Netto', key: 'patrimonioNetto' },
                { label: 'Debiti Totali', key: 'debiti' },
                { label: 'DisponibilitÃ  Liquide', key: 'disponibilitaLiquide' },
                { label: 'Immobilizzazioni', key: 'immobilizzazioni' }
            ];

            patrimonialRows.forEach(row => {
                patrimonialHTML += `<tr><td>${row.label}</td>`;
                selectedYears.forEach(year => {
                    patrimonialHTML += `<td class="number">${formatCurrency(bilanciData[year][row.key])}</td>`;
                });
                patrimonialHTML += '</tr>';
            });
            patrimonialHTML += '</tbody></table>';
            document.getElementById('patrimonial-table').innerHTML = patrimonialHTML;
        }

        function createIndiceCard(title, key, values, isPercentage = false) {
            const selectedYears = getSelectedYears();
            let valuesHTML = '';
            selectedYears.forEach(year => {
                const value = isPercentage ? formatPercentage(values[year][key]) : values[year][key].toFixed(2);
                valuesHTML += `<div class="indice-row"><span>${year}:</span><span>${value}</span></div>`;
            });

            return `
                <div class="indice-card">
                    <h4 onclick="toggleExplanation('${key}')">${title} <span>â–¼</span></h4>
                    <div class="explanation" id="exp-${key}">${explanations[key]}</div>
                    <div class="indice-values">${valuesHTML}</div>
                </div>
            `;
        }

        function showTab(tabName) {
            // Nasconde tutti i contenuti
            document.getElementById('bilanci-content').style.display = 'none';
            document.getElementById('grafici-content').style.display = 'none';
            document.getElementById('indici-content').style.display = 'none';

            // Mostra il contenuto selezionato
            document.getElementById(tabName + '-content').style.display = 'block';

            // Aggiorna i tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Crea i grafici quando necessario
            if (tabName === 'grafici') {
                setTimeout(createCharts, 100);
            }
            
            if (tabName === 'indici') {
                populateIndici();
                setTimeout(createIndicatorCharts, 100);
            }
        }

        function populateIndici() {
            const indici = calcolaIndici();

            // Indici di redditivitÃ 
            let redditHTML = '';
            redditHTML += createIndiceCard('EBITDA Margin', 'ebitdaMargin', indici, true);
            redditHTML += createIndiceCard('ROI', 'roi', indici, true);
            redditHTML += createIndiceCard('ROA', 'roa', indici, true);
            redditHTML += createIndiceCard('ROS', 'ros', indici, true);
            document.getElementById('indici-redditivita').innerHTML = redditHTML;

            // Indici finanziari
            let finanzHTML = '';
            finanzHTML += createIndiceCard('Current Ratio', 'currentRatio', indici);
            finanzHTML += createIndiceCard('Quick Ratio', 'quickRatio', indici);
            finanzHTML += createIndiceCard('Debt/Equity', 'debtToEquity', indici);
            document.getElementById('indici-finanziari').innerHTML = finanzHTML;

            // Indici patrimoniali
            let patrimHTML = '';
            patrimHTML += createIndiceCard('Autonomia Finanziaria', 'autonomiaFinanziaria', indici, true);
            patrimHTML += createIndiceCard('Copertura Immobilizzazioni', 'coperturaImmobilizzazioni', indici, true);
            patrimHTML += createIndiceCard('Composizione Attivo', 'composizioneAttivo', indici, true);
            document.getElementById('indici-patrimoniali').innerHTML = patrimHTML;
        }

        function toggleExplanation(key) {
            const explanation = document.getElementById(`exp-${key}`);
            explanation.classList.toggle('show');
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            updateTables();
        });
    </script>
</body>
</html>
